---
title: "var_grabs"
author: "Katie Willi"
date: "2025-04-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(terra)
library(elevatr)
library(dataRetrieval)
library(nhdplusTools)
library(StreamCatTools)
library(tmap)
library(climateR)
library(data.table)
library(mapview)
list.files("src/", full.names = TRUE) %>%
  walk(~source(.))
```

```{r, eval = FALSE}
site_nos <- c(
  "06309200", "06614800", "06622700", "06632400", "06755960", "06712000", "06715000", "06718550",
  "06823500", "06824000", "06836500", "07083000", "07103703", "07105000", "07105490", "07105900",
  "07111000", "07114000", "07121500", "07124200", "07203000", "07206000", "07207500", "07208500",
  "07218000", "08213500", "08214500", "08218500", "08220500", "08220900", "08224500", "08226700",
  "08227000", "08227500", "08229500", "08230500", "08231000", "08238000", "08241500", "08242500",
  "08245000", "08247500", "08248000", "08250000", "08267500", "08269000", "08271000", "08275500",
  "08277470", "08284100", "08289000", "08291000", "08294210", "08302500", "08315480", "08324000",
  "08334000", "08377900", "08380500", "09025300", "09047700", "09059500", "09065100", "09065500",
  "09066000", "09066200", "09066300", "09077000", "09078500", "09081600", "09112200", "09124500",
  "09165000", "09217900", "09220000", "09246200", "09253000", "09255000", "09279000", "09289500",
  "09292000", "09296800", "09299500", "09306200", "09306242", "09344000", "09358550", "09362750",
  "09378170", "09378630", "09386900", "402114105350101", "AZOTUNNM", "BEACEMCO", "BEVBEVCO",
  "BIGSPGCO", "BIGUPPCO", "BOBCRKCO", "BOCMIDCO", "BTNFDRCO", "BUCRMVCO", "CANNEWCO", "CANSWKCO",
  "CASCOSNM", "CCACCRCO", "CHAGULCO", "CHCRNACO", "CHECRECO", "CHEREDCO", "CHIDEVCO", "CLEGLKCO",
  "COCRBVCO", "COCREPCO", "COCRWOCO", "COSABONM", "CRHBLVCO", "CULCHACO", "DOUOUTCO", "ELKMILCO",
  "ELKNEWCO", "ERIRGRCO", "FIRBUCCO", "FISCRECO", "FOUHIGCO", "FOUOROCO", "FRNCRKCO", "FRYIVLCO",
  "FRYSFUCO", "GARVILCO", "GRAWESCO", "HAYREDCO", "HUEBADCO", "JEFJEFCO", "KANJUNCO", "LAKATLCO",
  "LAPHESCO", "LEFCRECO", "LINGRRCO", "LITOSOCO", "LTCANYCO", "LUARMOCO", "LVNGEOCO", "LKCTURCO",
  "LONREDCO", "MAJVILCO", "MANMANCO", "MEDSANCO", "MERINFCO", "MFKABMCO", "MIDSTECO", "MONGATCO",
  "MUDAACCO", "MUDHIGCO", "OHGJEFCO", "OHIBALCO", "PARPARCO", "PLAGRACO", "PLUCASCO", "RALCRKCO",
  "RCKTARCO", "RIOBLACO", "RITCRECO", "ROCAFOCO", "SALTOXCO", "SANCOSNM", "SANCRECO", "SANDUNCO",
  "SCHFLMCO", "SFKANTCO", "SMILAZCO", "SOUCRECO", "SPACRECO", "SSVWARCO", "SVCLYOCO", "TARUPPCO",
  "TAYATPCO", "TRITURCO", "TROGARCO", "TROUBLCO", "TURBCRCO", "TURTELCO", "VALBAYCO", "VANMODCO",
  "WESRIFCO", "WFKCROCO", "WILBSLCO", "WILCRECO", "WILDHOCO")

length(site_nos)

nwis_sites <- readRDS('data/katie/nwis_sites_data_record_nldi.RDS')

raw_watersheds <- list.files("data/katie/watersheds/", full.names = TRUE) %>%
  map_dfr(~readRDS(.) %>% mutate(comid = as.numeric(comid))) %>%
  st_make_valid() %>%
  # add states back in:
  inner_join(all_sites %>%
               select(agency_cd, site_pretty, site_no) %>% 
               st_drop_geometry(.) , by = "site_no") %>%
  # These are massive watersheds (well beyond 15k sq.km.:)
  filter(!site_no %in% c("PURNINCO", "PLACROCO", "PLAJURCO", 
                         "ARKJMRCO", "ARKHOLCO", "COLUTACO", 
                         "PLAMORCO", "PLABALCO", "ARKLAMCO",
                         "GRNJENUT", "ARKROCCO", "ONEJURCO",
                         "ARKCOOKS", "ARKGARKS", "ARKSYRKS", 
                         "RIOALBNM", "PLAROSNE", "RGFSANNM", 
                         "SMFRIONM", "RIOELENM", "ARKGRACO")) %>%
  mutate(total_area_km2 = as.numeric(st_area(.)) / 1000000) %>%
  filter(total_area_km2 <= 1500) %>%
  mutate(old_site_no =  str_extract(site_pretty, "(?<=-).*")) %>%
  arrange(agency_cd) %>%
  distinct(old_site_no, .keep_all = TRUE)  %>%
  select(site_no, comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2)

saveRDS(raw_watersheds, "data/katie/all_raw_watersheds.RDS")
```

```{r}
raw_watersheds <- readRDS("data/katie/all_raw_watersheds.RDS")

new_watersheds <- readRDS("data/katie/all_raw_watersheds.RDS") %>%
  filter(site_no %in% c("YELWHICO", "BEAPENCO", "COSBELNM", "TARCOMCO", 
                        "401733105392404", "CULCHACO", "ELKNEWCO", "WINDESCO"))

watersheds <- st_read("data/katie/for_stephanie/all_watersheds.shp") #%>%
  #filter(site_no %in% site_nos | old_st_ %in% site_nos) %>%
  left_join(st_drop_geometry(raw_watersheds), by = "site_no")

update <- watersheds %>%
 filter(site_no %in% c("YELWHICO", "BEAPENCO", "COSBELNM", "TARCOMCO", 
                        "401733105392404", "CULCHACO", "ELKNEWCO", "WINDESCO"))
```


```{r}
watersheds_screened <- st_read('data/katie/for_stephanie/watersheds_screened_20250414.shp')

watersheds <- raw_watersheds %>%
  filter(site_no %in% watersheds_screened$site_no) #%>%
#select(site_no, comid)
```

Grab explanatory variables

Link up gages with streamcat variables. StreamCat watershed statistics are available for every stream feature in the NHDPlusV2. StreamCat uses the comid as the identifier so we can link up information that way. A complete list of available variables you can pull is found in the vars table below. I am NOT pulling in all the available info that you can because these soooo much!

```{r, eval = FALSE}
# Grab a list of all available streamcat variables:
# download.file("https://java.epa.gov/StreamCAT/metrics/variable_info.csv",
#               destfile = paste0(getwd(), "/data/StreamCatVars.csv"))

# This table describes all the available variables in streamcat. Look here
# if you want to explore other vars, or the descriptions of the ones I've
# selected here:
# vars <- read_csv("data/StreamCatVars.csv")


# These are all the variables Fred was interested in for describing flow
# in his work. Likely a good starting point for our needs, too. 
selected_vars <- c(
  # Urban cover (add all together to get percent of total urban cover): 
  # Many available years. Which do we want to use?
  #"PctUrbOp2019", "PctUrbMd2019", "PctUrbLo2019", "PctUrbHi2019",
  
  #"CanalDens",
  # BFI
  "BFI", 
  #NLCD
  #"PctOw2019", "PctIce2019", "PctUrbOp2019", "PctUrbLo2019", "PctUrbMd2019", "PctUrbHi2019",
  #"PctBl2019", "PctDecid2019", "PctConif2019", "PctMxFst2019", "PctShrb2019",  "PctGrs2019",
  #"PctHay2019", "PctCrop2019",  "PctWdWet2019", "PctHbWet2019",
  # Road Density (percent)
  #"rddens",
  # Dam Info
  #"DamDens", "DamNIDStor", "DamNrmStor",
  # Impervious Surfaces across a bunch of years:
  # "PctImp2006", "PctImp2008", "PctImp2011", "PctImp2001",
  # "PctImp2013", "PctImp2016", "PctImp2004",
  #"PctImp2019",
  # # Soil, STATSGO variables:
  #"Clay", "Sand", "Rckdep", "WtDep", "Perm"
) %>% tolower()

streamcat_vars <- StreamCatTools::sc_get_data(metric = paste(selected_vars, collapse = ","),
                                              aoi = 'watershed', 
                                              comid = watersheds$comid) %>%
  # remove variables we don't particularly care about that get returned:
  select(-contains("AREASQKM"))

streamcat_list_simple <- watersheds %>%
  left_join(., streamcat_vars, by = c("comid")) %>%
  mutate(pcturb2019ws = pcturbhi2019ws + pcturbmd2019ws + pcturblo2019ws)

for_stephanie <- streamcat_list_simple %>%
  mutate(comid = as.character(comid)) %>%
  select(site_no, 
         comid, 
         #class,
         canalden = canaldensws, 
         damnrmstor = damnrmstorws,
         damden = damdensws, 
         damnidstor = damnidstorws, 
         pcturb2019 = pcturb2019ws,
         rdden = rddensws,
         geometry)

st_write(for_stephanie, "data/katie/vars_for_stephanie.shp", append = FALSE)

test = st_read("data/katie/vars_for_stephanie.shp")
names(test)
```

##### Area-normalized StreamCat variables

```{r, eval = FALSE}
# Urban cover (add all together to get percent of total urban cover): 
selected_vars <- c(
  # "PctUrbMd2019", "PctUrbLo2019", "PctUrbHi2019",
  # "CanalDensity", #CanalDens",
  # # BFI
  # # "BFI", 
  # # NLCD
  # "PctUrbLo2019", "PctUrbMd2019", "PctUrbHi2019",
  # "PctDecid2019", "PctConif2019", "PctMxFst2019", "PctShrb2019",  "PctGrs2019",
  # "PctHay2019", "PctCrop2019",
  # # Road Density (percent)
  # "rddens",
  # # Dam Info
  # "DamDens", "DamNIDStor", "DamNrmStor",
  # # Impervious Surfaces across a bunch of years:
  # # "PctImp2006", "PctImp2008", "PctImp2011", "PctImp2001",
  # # "PctImp2013", "PctImp2016", "PctImp2004",
  # "PctImp2019",
  # # Soil, STATSGO variables:
  "Clay", "Sand", "Rckdep", "WtDep", "Perm") %>% 
  tolower()

streamcat_norm <- watersheds %>%
  normalized_streamcat_data(df = ., selected_vars = selected_vars) %>%
  mutate(across(where(is.numeric), ~ifelse(is.nan(.), 0, .))) %>%
  mutate(across(where(is.numeric), ~ifelse(. < 0, 0, .))) %>%
  # mutate(pcturb2019ws = pcturbhi2019ws + pcturbmd2019ws + pcturblo2019ws,
  #        pctforest2019ws = pctdecid2019ws + pctconif2019ws + pctmxfst2019ws) %>%
  select(-c(comid, area_original_m2, geometry, area_updated_m2, area_dif_m2, total_area_km2, catareasqkm, catareasqkmrp100, wsareasqkm, wsareasqkmrp100)) %>% st_drop_geometry() %>%
  rename_with(~ paste0(., "_normalized"), -site_no) 
```


```{r}
selected_vars <- c(
  # # Soil, STATSGO variables:
  "Clay", "Sand", "Rckdep", "WtDep", "Perm") %>% 
  tolower()

streamcat_sim <- watersheds %>%
  simple_streamcat_data(.) %>%
  mutate(across(where(is.numeric), ~ifelse(is.nan(.), 0, .))) %>%
  mutate(across(where(is.numeric), ~ifelse(. < 0, 0, .))) %>%
  # mutate(pcturb2019ws = pcturbhi2019ws + pcturbmd2019ws + pcturblo2019ws,
  #        pctforest2019ws = pctdecid2019ws + pctconif2019ws + pctmxfst2019ws) %>%
  select(-c(comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2)) %>% st_drop_geometry() %>%
  rename_with(~ paste0(., "_streamcat"), -site_no) 
```

Grab other variables not found in stream cat:

##### Aspect features

Dominant aspect requires a bit of a wonky workflow - I'm not quite sure if there's an easier approach than what I'm presenting here. I grab raw elevation DEMs, get the aspect (in degrees) for each grid cell, then convert those raw aspects (in degrees) into categorical N, E, S, W cardinal directions as displayed in this image below:

```{r, eval = FALSE}
watersheds_aspects <- watersheds %>%
  aspect_grabber(.) %>%
  select(-c(comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2)) %>% st_drop_geometry()
write_csv(watershed_aspects, "data/katie/var_data_backup/watershed_aspects.csv")
```

```{r}
watersheds_aspects <- read_csv("data/katie/var_data_backup/watershed_aspects.csv") %>%
  select(-c(comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2, geometry)) %>% st_drop_geometry()
```

##### Snow persistence

Here I am loading in all the snow persistence data I downloaded from: https://www.sciencebase.gov/catalog/item/5f63790982ce38aaa23a3930. There is annual snow persistence data from 2001-2020. Using the {terra} package, I get the area-weighted annual average snow persistence value for each watershed, then average each year's data together to get a single time- and area-weighted average for each watershed.

```{r}
watersheds_sp <- watersheds %>%
  snow_persistence_grabber(.) %>%
  select(-c(comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2)) %>% st_drop_geometry()
```

##### Daymet variables

```{r}
watersheds_daymet <- watersheds %>%
  daymet_grabber(.) %>%
  select(-c(comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2)) %>% st_drop_geometry()
```

##### Geology variables

```{r}
watersheds_geology <- watersheds %>%
  geology_grabber(.) %>%
  select(-c(comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2)) %>% st_drop_geometry()
```

##### Dam variables

```{r}
watersheds_dams <- watersheds %>%
  dam_grabber(.) %>%
  select(-c(comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2)) %>% st_drop_geometry()
```

##### NLCD variables

```{r}
watersheds_nlcd <- watersheds %>%
  nlcd_grabber(.)
write_csv(watersheds_nlcd, "data/katie/watersheds_nlcd.csv")
```

```{r}
watersheds_nlcd <- read_csv('data/katie/watersheds_nlcd.csv') %>%
  select(-c(comid, area_original_m2, area_updated_m2, area_dif_m2, total_area_km2, geometry)) %>%
  st_drop_geometry()
```

# Road density
```{r}
watersheds_roads <- watersheds %>%
  road_density_grabber() %>%
  select(site_no, road_density_km_per_km2) %>%
  st_drop_geometry()
```

```{r}
watersheds_ssurgo <- watersheds %>%
  ssurgo_grabber() 

saveRDS(watersheds_ssurgo, "data/katie/watersheds_ssurgo.RDS")
```

## Bind all together

```{r}
watersheds_with_vars <- watersheds %>%
  select(site_no, comid) %>%
  mutate(ws_area_sqkm = as.numeric(st_area(.)/1000000)) %>%
  left_join(st_drop_geometry(watersheds_screened), by = "site_no") %>%
  select(site_no, old_site_no = old_st_, comid, mdf_typ, ws_area_sqkm) %>%
  #left_join(streamcat_norm, by = "site_no") %>%
  #left_join(streamcat_sim, by = "site_no") %>%
  left_join(watersheds_aspects, by = "site_no") %>%
  left_join(watersheds_daymet, by = "site_no") %>%
  left_join(watersheds_sp, by = "site_no") %>%
  left_join(watersheds_geology, by = "site_no") %>%
  left_join(watersheds_dams, by = "site_no")  %>%
  left_join(watersheds_nlcd, by = "site_no") %>%
  left_join(watersheds_roads, by = "site_no") %>%
  #left_join(watersheds_ssurgo, by = "site_no") %>%
  left_join(streamcat_sim, by = "site_no")

write_csv(watersheds_with_vars, "data/katie/for_stephanie/watersheds_with_vars.csv")
```

```{r}
watersheds_with_vars <- read_csv("data/katie/for_stephanie/watersheds_with_vars.csv") %>%
  cbind(urb_pct %>% select(Urban_Percent = 1))

write_csv(watersheds_with_vars, "data/katie/for_stephanie/watersheds_with_vars.csv")
```


## Metadata
```{r}
# Create updated metadata for watershed variables
# Based on the watershed_with_vars data frame structure and source files

# Create each column as a separate vector first
variables <- c(
  # Basic Watershed Information
  "site_no", "old_site_no", "comid", "mdf_typ", "ws_area_sqkm",
  
  # Aspect Features
  "dominant_aspect", "mean_slope_mm", "slope30", "northness_mean", "north_fraction",
  
  # Daymet SWE Variables
  "swe_jan", "swe_feb", "swe_mar", "swe_apr", "swe_may", "swe_jun", 
  "swe_avg", "swe_peak",
  
  # Daymet Precipitation Variables
  "prcp_jan", "prcp_feb", "prcp_mar", "prcp_apr", "prcp_may", "prcp_jun", 
  "prcp_jul", "prcp_aug", "prcp_sep", "prcp_oct", "prcp_nov", "prcp_dec", 
  "prcp_avg", "prcp_peak",
  
  # Snow Persistence Variables
  "mean_sp_2001_2020", "area60",
  
  # Geology Variables
  "perc_intrusive", "perc_metamorphic", "perc_volcanic", 
  "perc_sedimentary_clastic", "perc_sedimentary_chemical", "perc_sedimentary_carbonate",
  "perc_unconsolidated", "perc_mix",
  
  # Dam Variables from NID
  "damdensws_nid", "damnidstorws_nid", "damnrmstorws_nid",
  
  # NLCD Variables
  "Forest_Percent", "Grassland_Percent", "Shrub_Percent", "Agriculture_Percent", 
  "Impervious_Percent",
  
  # Road Density
  "road_density_km_per_km2", 
  
  # StreamCat Soil Variables (replacing SSURGO)
  "sandws_streamcat", "clayws_streamcat", "permws_streamcat", "wtdepws_streamcat", "rckdepws_streamcat"
)

descriptions <- c(
  # Basic Watershed Information
  "Site identification number", "Previous site identification number", 
  "NHDPlus Common Identifier for stream segment", "Modified flow type classification", 
  "Watershed area in square kilometers",
  
  # Aspect Features
  "Most common aspect direction in watershed", 
  "Mean slope in meters/meter", 
  "Fraction of drainage area with slopes > 0.3 m/m", 
  "Mean northness (sin(slope) * cos(aspect))", 
  "Fraction of drainage area with north-facing slopes",
  
  # Daymet SWE Variables
  "Mean snow water equivalent - January", 
  "Mean snow water equivalent - February", 
  "Mean snow water equivalent - March", 
  "Mean snow water equivalent - April", 
  "Mean snow water equivalent - May", 
  "Mean snow water equivalent - June", 
  "Annual mean snow water equivalent", 
  "Mean annual peak snow water equivalent",
  
  # Daymet Precipitation Variables
  "Mean precipitation - January", 
  "Mean precipitation - February", 
  "Mean precipitation - March", 
  "Mean precipitation - April", 
  "Mean precipitation - May", 
  "Mean precipitation - June", 
  "Mean precipitation - July", 
  "Mean precipitation - August", 
  "Mean precipitation - September", 
  "Mean precipitation - October", 
  "Mean precipitation - November", 
  "Mean precipitation - December", 
  "Annual mean precipitation", 
  "Mean annual peak precipitation",
  
  # Snow Persistence Variables
  "Mean snow persistence 2001-2020", 
  "Fraction of watershed with snow persistence > 60%",
  
  # Geology Variables
  "Percent of watershed with intrusive igneous rocks", 
  "Percent of watershed with metamorphic rocks", 
  "Percent of watershed with volcanic igneous rocks", 
  "Percent of watershed with clastic sedimentary rocks", 
  "Percent of watershed with chemical sedimentary rocks", 
  "Percent of watershed with carbonate sedimentary rocks", 
  "Percent of watershed with unconsolidated deposits", 
  "Percent of watershed with mixed/undifferentiated rock types",
  
  # Dam Variables from NID
  "Dam density from National Inventory of Dams",
  "Dam storage volume from National Inventory of Dams",
  "Normal dam storage volume from National Inventory of Dams",
  
  # NLCD Variables
  "Percent of watershed classified as forest (NLCD classes 41, 42, 43)",
  "Percent of watershed classified as grassland/herbaceous (NLCD class 71)",
  "Percent of watershed classified as shrub/scrub (NLCD class 52)",
  "Percent of watershed classified as agriculture (NLCD classes 81, 82)",
  "Percent of watershed with impervious surfaces",
  
  # Road Density
  "Road density in kilometers per square kilometer",
  
  # StreamCat Soil Variables
  "Percent sand content in soil",
  "Percent clay content in soil",
  "Soil permeability",
  "Water table depth",
  "Depth to bedrock"
)

sources <- c(
  # Basic Watershed Information
  "Original dataset", "Original dataset", "NHDPlus", 
  "watersheds_screened dataset", "Calculated from geometry",
  
  # Aspect Features
  rep("Calculated from DEMs using elevatr package", 5),
  
  # Daymet SWE Variables
  rep("Daymet", 6),
  rep("Calculated from Daymet", 2),
  
  # Daymet Precipitation Variables
  rep("Daymet", 12),
  rep("Calculated from Daymet", 2),
  
  # Snow Persistence Variables
  "MODIS Snow Cover Index", "Calculated from MODIS",
  
  # Geology Variables
  rep("USGS State Geologic Map Compilation", 8),
  
  # Dam Variables from NID
  rep("National Inventory of Dams", 3),
  
  # NLCD Variables
  rep("NLCD 2019", 5),
  
  # Road Density
  "TIGER/Line roads dataset",
  
  # StreamCat Soil Variables
  rep("StreamCat", 5)
)

units <- c(
  # Basic Watershed Information
  "Text", "Text", "Integer", "Text", "Square kilometers",
  
  # Aspect Features
  "Cardinal direction", "m/m", "Ratio (0-1)", "Dimensionless (-1 to 1)", "Ratio (0-1)",
  
  # Daymet SWE Variables
  rep("kg/m²", 8),
  
  # Daymet Precipitation Variables
  rep("mm/day", 14),
  
  # Snow Persistence Variables
  "Percent time with snow cover", "Ratio (0-1)",
  
  # Geology Variables
  rep("Percent", 8),
  
  # Dam Variables from NID
  "count/km²", "acre-feet/km²", "acre-feet/km²",
  
  # NLCD Variables
  rep("Percent", 5),
  
  # Road Density
  "km/km²",
  
  # StreamCat Soil Variables
  "Percent", "Percent", "cm/hr", "mm", "mm"
)

categories <- c(
  # Basic Watershed Information
  rep("Basic Watershed Information", 5),
  
  # Aspect Features
  rep("Aspect Features", 5),
  
  # Daymet SWE Variables
  rep("Daymet SWE Variables", 8),
  
  # Daymet Precipitation Variables
  rep("Daymet Precipitation Variables", 14),
  
  # Snow Persistence Variables
  rep("Snow Persistence", 2),
  
  # Geology Variables
  rep("Geology Variables", 8),
  
  # Dam Variables from NID
  rep("Dam Variables", 3),
  
  # NLCD Variables
  rep("NLCD Variables", 5),
  
  # Road Density
  "Road Density",
  
  # StreamCat Soil Variables
  rep("StreamCat Soil Variables", 5)
)

calculations <- c(
  # Basic Watershed Information
  "Direct measurement", "Direct measurement", "Direct measurement", 
  "Direct measurement", "Calculated from watershed polygon geometry",
  
  # Aspect Features
  "Mode of cardinal directions derived from DEM",
  "Mean slope calculated from DEM",
  "Fraction of cells with slope > 0.3 m/m",
  "Mean of sin(slope) * cos(aspect) across all cells",
  "Fraction of cells with north-facing aspect",
  
  # Daymet SWE Variables
  rep("Monthly mean across years (2001-2020)", 6),
  "Mean of all monthly values", "Mean of annual maximum values",
  
  # Daymet Precipitation Variables
  rep("Monthly mean across years (2001-2020)", 12),
  "Mean of all monthly values", "Mean of annual maximum values",
  
  # Snow Persistence Variables
  "Mean of annual snow persistence values 2001-2020", 
  "Fraction of watershed with mean snow persistence > 60%",
  
  # Geology Variables
  rep("Percent area by rock type from spatial intersection", 8),
  
  # Dam Variables from NID
  "Count of dams divided by watershed area",
  "Total storage volume divided by watershed area",
  "Total normal storage volume divided by watershed area",
  
  # NLCD Variables
  "Percent of cells classified as forest (classes 41, 42, 43)",
  "Percent of cells classified as grassland (class 71)",
  "Percent of cells classified as shrub/scrub (class 52)",
  "Percent of cells classified as agriculture (classes 81, 82)",
  "Mean impervious percentage across watershed",
  
  # Road Density
  "Total road length divided by watershed area",
  
  # StreamCat Soil Variables
  "Area-weighted mean of sand content across watershed",
  "Area-weighted mean of clay content across watershed",
  "Area-weighted mean of permeability across watershed",
  "Area-weighted mean of water table depth across watershed",
  "Area-weighted mean of bedrock depth across watershed"
)

# Create the dataframe
watershed_metadata <- data.frame(
  variable = variables,
  description = descriptions,
  source = sources,
  units = units,
  category = categories,
  calculation = calculations,
  stringsAsFactors = FALSE
)

# Display metadata
watershed_metadata

write_csv(watershed_metadata, "data/katie/for_stephanie/watersheds_with_vars_meta.csv")
```


1. The 'normalized' suffix on StreamCat variables indicates that the area-normalized watershed statistics have been calculated, in an attempt to address for the portion of catchments that are actually upstream of the gauge.
2. The 'simple' suffix on StreamCat variables indicates the original watershed-level statistics without normalization.
3. Aspect features are derived from DEMs using terrain analysis in the {terra} package.
4. Snow persistence data comes from MODIS satellite imagery (MOD10A2) for 2001-2020.
5. Daymet climate variables are averaged across water years (October to September) from 2001-2020. I am using monthly averages. Meaning, the "peak" value is not a daily peak, but the average of all the maximum monthly averages per water year. I can get daily if that is needed (it's just a lot slower).
6. Peak values for SWE and precipitation are calculated as the mean of annual maximum monthly values over the 2001-2020 period, representing average annual peak conditions.
7. Only winter/spring months (January-June) are retained for SWE variables.
8. Geology variables represent the percentage of the watershed area occupied by different rock types, based on USGS geological data you shared with us.
9. Dam variables derived directly from the National Inventory of Dams (NID) data provide an alternative measure to the StreamCat dam variables.
